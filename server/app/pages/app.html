<form class="flex h-full gap-4 p-4" name="board">
  <% board.lanes.forEach((lane) => { %>
    <%- include('lane.html', { board, lane }) %>
  <% }); %>

  <div class="min-w-[var(--lane-width)]">
    <button
      type="button"
      class="self-start p-3 bg-white border rounded text-left hover:pr-[calc(var(--lane-width)-2.5rem)] transition-[padding]"
      hx-on::before-request="
        // TODO: Handle request failure
        this.closest('form').insertBefore(this.nextElementSibling.content.cloneNode(true), this.parentElement);
        this.scrollIntoView({ behavior: 'smooth' });
      "
      hx-post="/boards/<%= board._id %>/lanes"
      hx-swap="outerHTML"
      hx-target="closest form"
    >
      âž•
    </button>

    <template>
      <%- include('lane.html', { board, lane: constants.NEW_LANE }) %>
    </template>
  </div>

  <script>
    const taskUpdateTimers = {};

    function updateOrDeleteTask(container, laneId, taskId) {
      clearTimeout(taskUpdateTimers[taskId]);
      taskUpdateTimers[taskId] = setTimeout(() => {
        const text = container.textContent;

        if (text) {
        fetch(
          `/boards/<%= board._id %>/lanes/${laneId}/tasks/${taskId}`,
          { method: 'PUT', body: text, }
        )
          .then((response) => response.ok ? response.text() : null)
          .then((html) => {
            if (html) {
              container.outerHTML = html;
            }
          });
        } else {
          // Optimistically remove task
          const parent = container.parentElement;
          const previousSibling = container.previousElementSibling;
          parent.removeChild(container);

          fetch(
            `/boards/<%= board._id %>/lanes/${laneId}/tasks/${taskId}`,
            { method: 'DELETE' }
          )
            .then((response) => {
              // Restore task
              if (!response.ok) {
                if (previousSibling) {
                  previousSibling.after(container);
                } else {
                  parent.prepend(container);
                }
              }
            })
        }
      }, 300);
    }
  </script>
</form>
